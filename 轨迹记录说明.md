# 工作流轨迹记录功能说明

## 功能概述

系统现在会自动记录每次代码运行的完整轨迹，包括：
- 每次运行的开始和结束时间
- 每个节点的执行状态和耗时
- 状态变化记录
- 错误信息
- 执行摘要

## 日志文件位置

轨迹日志文件保存在以下目录：
```
outputs/logs/workflow_traces/
```

每次运行会生成两个文件：
1. **JSON格式轨迹文件**：`trace_run_YYYYMMDD_HHMMSS.json`
   - 包含完整的结构化轨迹数据
   - 可用于程序化分析和可视化

2. **文本格式日志文件**：`trace_run_YYYYMMDD_HHMMSS.log`
   - 人类可读的日志格式
   - 包含详细的执行信息

## 轨迹文件内容

### JSON轨迹文件结构

```json
{
  "run_id": "run_20260114_134405",
  "start_time": "2026-01-14T13:44:05.123456",
  "end_time": "2026-01-14T14:08:13.654321",
  "duration_seconds": 1208.53,
  "original_query": "用户的研究问题",
  "initial_state": {...},
  "final_state": {...},
  "nodes": [
    {
      "node_name": "literature_search",
      "node_type": "subgraph",
      "start_time": "2026-01-14T13:44:05.123456",
      "end_time": "2026-01-14T13:44:32.654321",
      "duration_seconds": 26.48,
      "status": "completed",
      "state_snapshot": {...},
      "state_changes": [...]
    },
    ...
  ],
  "errors": [],
  "summary": {
    "total_nodes": 6,
    "successful_nodes": 6,
    "failed_nodes": 0,
    "total_duration": 1208.53
  }
}
```

### 文本日志文件示例

```
2026-01-14 13:44:05 | INFO     | ================================================================================
2026-01-14 13:44:05 | INFO     | 开始工作流执行 - Run ID: run_20260114_134405
2026-01-14 13:44:05 | INFO     | 用户查询: 用户的研究问题
2026-01-14 13:44:05 | INFO     | 开始时间: 2026-01-14T13:44:05.123456
2026-01-14 13:44:05 | INFO     | ================================================================================
2026-01-14 13:44:05 | INFO     | [节点开始] literature_search (subgraph)
2026-01-14 13:44:32 | INFO     | [节点完成] literature_search (耗时: 26.48秒)
...
```

## 使用方法

轨迹记录功能已自动集成到工作流中，无需额外配置。每次运行 `main_with_progress()` 函数时，系统会自动：

1. 创建新的轨迹记录器
2. 记录初始状态和用户查询
3. 记录每个节点的执行过程
4. 记录状态变化和错误信息
5. 在运行结束时保存轨迹文件

## 查看轨迹

### 查看最近的轨迹文件

```bash
# 查看最新的JSON轨迹文件
ls -lt outputs/logs/workflow_traces/trace_*.json | head -1

# 查看最新的文本日志文件
ls -lt outputs/logs/workflow_traces/trace_*.log | head -1
```

### 分析轨迹数据

可以使用Python脚本分析轨迹数据：

```python
import json
from pathlib import Path

# 读取轨迹文件
trace_file = Path("outputs/logs/workflow_traces/trace_run_20260114_134405.json")
with open(trace_file, 'r', encoding='utf-8') as f:
    trace_data = json.load(f)

# 查看摘要
print(f"运行ID: {trace_data['run_id']}")
print(f"总耗时: {trace_data['duration_seconds']}秒")
print(f"成功节点: {trace_data['summary']['successful_nodes']}")
print(f"失败节点: {trace_data['summary']['failed_nodes']}")

# 查看每个节点的耗时
for node in trace_data['nodes']:
    print(f"{node['node_name']}: {node['duration_seconds']}秒")
```

## 注意事项

1. **日志文件大小**：文本日志文件设置了自动轮转（100MB）和保留期（30天），避免占用过多磁盘空间。

2. **性能影响**：轨迹记录对性能的影响很小，主要是在内存中记录数据，最后一次性写入文件。

3. **状态序列化**：某些复杂对象（如LangChain消息）会被序列化为字符串，以支持JSON格式保存。

4. **并发运行**：每次运行都有唯一的run_id，支持并发运行而不会相互干扰。

## 故障排除

如果轨迹文件没有生成，请检查：

1. 日志目录权限：确保 `outputs/logs/workflow_traces/` 目录有写权限
2. 磁盘空间：确保有足够的磁盘空间
3. 查看错误日志：检查是否有相关的错误信息
